package utils

import (
	"math/big"

	"github.com/ethereum/go-ethereum/accounts/abi/bind"
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/crypto"
	"github.com/stader-labs/stader-node/stader-lib/stader"
	rptypes "github.com/stader-labs/stader-node/stader-lib/types"
)

// Combine a node's address and a salt to retreive a new salt compatible with depositing
func GetNodeSalt(nodeAddress common.Address, salt *big.Int) common.Hash {
	// Create a new salt by hashing the original and the node address
	saltBytes := [32]byte{}
	salt.FillBytes(saltBytes[:])
	saltHash := crypto.Keccak256Hash(nodeAddress.Bytes(), saltBytes[:])
	return saltHash
}

// Precompute the address of a minipool based on the node wallet, deposit type, and unique salt
// If you set minipoolBytecode to nil, this will retrieve it from the contracts using minipool.GetMinipoolBytecode().
func GenerateAddress(ethxcm *stader.PermissionlessNodeRegistryContractManager, nodeAddress common.Address, depositType rptypes.MinipoolDeposit, salt *big.Int, minipoolBytecode []byte, opts *bind.CallOpts) (common.Address, error) {

	minipoolBytecodeCurrent := []byte("0x608060405234801561001057600080fd5b50611fc9806100206000396000f3fe60806040526004361061014f5760003560e01c80638dbd1d40116100b6578063b6989ca31161006f578063b6989ca3146103d0578063be9b721c146103f0578063d0d25e9e14610412578063d547741f14610432578063f16f6b9114610452578063f8df72e51461047457600080fd5b80638dbd1d40146103315780638ee59f761461033957806391d1485414610359578063a217fddf14610379578063a73839f71461038e578063a8ddff38146103b057600080fd5b806336bf33251161010857806336bf33251461027b57806340d1142714610298578063513d0bcb146102b85780635614c2a9146102f05780635b8bb23b146103065780635c975abb1461031957600080fd5b806301ffc9a71461019057806316b0d56d146101c55780631ccd0919146101e9578063248a9ca31461020b5780632f2ff15d1461023b57806336568abe1461025b57600080fd5b3661018b5760405134815233907f4103257eaac983ca79a70d28f90dfc4fa16b619bb0c17ee7cab0d4034c2796249060200160405180910390a2005b600080fd5b34801561019c57600080fd5b506101b06101ab36600461159b565b6104a8565b60405190151581526020015b60405180910390f35b3480156101d157600080fd5b506101db60c95481565b6040519081526020016101bc565b3480156101f557600080fd5b506102096102043660046115e1565b6104df565b005b34801561021757600080fd5b506101db6102263660046115fc565b60009081526065602052604090206001015490565b34801561024757600080fd5b50610209610256366004611615565b61057e565b34801561026757600080fd5b50610209610276366004611615565b6105a8565b34801561028757600080fd5b506101db6801bc16d674ec80000081565b3480156102a457600080fd5b506102096102b33660046115e1565b610626565b3480156102c457600080fd5b5060ce546102d8906001600160a01b031681565b6040516001600160a01b0390911681526020016101bc565b3480156102fc57600080fd5b506101db60ca5481565b61020961031436600461168a565b6106b3565b34801561032557600080fd5b5060975460ff166101b0565b6102096109e6565b34801561034557600080fd5b5060cd546102d8906001600160a01b031681565b34801561036557600080fd5b506101b0610374366004611615565b610ed2565b34801561038557600080fd5b506101db600081565b34801561039a57600080fd5b506101db600080516020611f7483398151915281565b3480156103bc57600080fd5b506102096103cb366004611749565b610efd565b3480156103dc57600080fd5b506102096103eb36600461178b565b610f28565b3480156103fc57600080fd5b506101db600080516020611f5483398151915281565b34801561041e57600080fd5b5060cb546102d8906001600160a01b031681565b34801561043e57600080fd5b5061020961044d366004611615565b611155565b34801561045e57600080fd5b5061046761117a565b6040516101bc9190611860565b34801561048057600080fd5b506101db7f782c2b8c180f233fd9fa1afd199f12a128e23d749abbac3ca9edf8eb98f2d34281565b60006001600160e01b03198216637965db0b60e01b14806104d957506301ffc9a760e01b6001600160e01b03198316145b92915050565b806001600160a01b03811661050f5760405162461bcd60e51b815260040161050690611873565b60405180910390fd5b600080516020611f7483398151915261052781611208565b60cd80546001600160a01b0319166001600160a01b0385169081179091556040519081527f9ea3d4ab5ce0102a316617bb8bbf02dbb10d19c7f7fd9903efd2e136658ebefb906020015b60405180910390a1505050565b60008281526065602052604090206001015461059981611208565b6105a38383611215565b505050565b6001600160a01b03811633146106185760405162461bcd60e51b815260206004820152602f60248201527f416363657373436f6e74726f6c3a2063616e206f6e6c792072656e6f756e636560448201526e103937b632b9903337b91039b2b63360891b6064820152608401610506565b610622828261129b565b5050565b806001600160a01b03811661064d5760405162461bcd60e51b815260040161050690611873565b600080516020611f7483398151915261066581611208565b60ce80546001600160a01b0319166001600160a01b0385169081179091556040519081527ff583e0ea5b9579df6531ea89b81be75889dde9f34d35e2402ca38e93c0b5db0a90602001610571565b7f782c2b8c180f233fd9fa1afd199f12a128e23d749abbac3ca9edf8eb98f2d3426106dd81611208565b34673782dace9d900000146107295760405162461bcd60e51b81526020600482015260126024820152711a5b9d985b1a590818dbdb1b185d195c985b60721b6044820152606401610506565b60ce5460405163617ec08360e01b8152600019916001600160a01b03169063617ec0839061075d908e908e906004016118cc565b602060405180830381865afa15801561077a573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061079e91906118e8565b146107eb5760405162461bcd60e51b815260206004820152601860248201527f76616c696461746f7220616c726561647920696e2075736500000000000000006044820152606401610506565b60cd54604051636d5f487960e11b8152600481018490526000916001600160a01b03169063dabe90f290602401602060405180830381865afa158015610835573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061085991906118e8565b905060001981036108e65760cd5460405162bcb6a360e71b81526001600160a01b0390911690635e5b5180906108af908990600080516020611f54833981519152908a908a908a90600190600090600401611901565b600060405180830381600087803b1580156108c957600080fd5b505af11580156108dd573d6000803e3d6000fd5b50505050610945565b60cd54604051634085450d60e01b8152600481018590526001600160a01b0390911690634085450d90602401600060405180830381600087803b15801561092c57600080fd5b505af1158015610940573d6000803e3d6000fd5b505050505b60ce54604051631be16c6760e11b81526001600160a01b03909116906337c2d8ce90610991908e908e908e908e908e90600080516020611f54833981519152908c903490600401611948565b600060405180830381600087803b1580156109ab57600080fd5b505af11580156109bf573d6000803e3d6000fd5b505060ca80549250905060006109d4836119ad565b91905055505050505050505050505050565b600080516020611f748339815191526109fe81611208565b6801bc16d674ec800000471015610a575760405162461bcd60e51b815260206004820152601d60248201527f6e6f7420656e6f7567682062616c616e636520746f206465706f7369740000006044820152606401610506565b600060ca5411610ac15760405162461bcd60e51b815260206004820152602f60248201527f7374616e64206279207065726d697373696f6e4c6573732076616c696461746f60448201526e72206e6f7420617661696c61626c6560881b6064820152608401610506565b6000610ad66801bc16d674ec800000476119c6565b905060ca548111610ae75780610aeb565b60ca545b90508060ca6000828254610aff91906119e8565b909155505060cd5460c95460405163f3e1f62960e01b8152600481018490526024810191909152600080516020611f54833981519152604482015260009182916001600160a01b039091169063f3e1f62990606401600060405180830381865afa158015610b71573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f19168201604052610b999190810190611a42565b60c9819055909250905060005b83811015610ecb5760ce5483516000916001600160a01b03169063d7abd17590600080516020611f5483398151915290879086908110610be857610be8611af0565b60200260200101516040518363ffffffff1660e01b8152600401610c16929190918252602082015260400190565b602060405180830381865afa158015610c33573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610c5791906118e8565b90506000198103610cb95760405162461bcd60e51b815260206004820152602660248201527f7065726d697373696f6e4c6573732076616c696461746f72206e6f7420617661604482015265696c61626c6560d01b6064820152608401610506565b60ce54604051635a1239c160e01b8152600481018390526000918291829182916001600160a01b0390911690635a1239c190602401600060405180830381865afa158015610d0b573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f19168201604052610d339190810190611b7a565b505060cb546040516304512a2360e31b8152959b50939950919750909550506001600160a01b03169250632289511891506801bc16d674ec80000090610d8490889060cc9089908990600401611c6a565b6000604051808303818588803b158015610d9d57600080fd5b505af1158015610db1573d6000803e3d6000fd5b505060ce54604051638704be8760e01b81526001600160a01b039091169350638704be879250610de691508790600401611860565b600060405180830381600087803b158015610e0057600080fd5b505af1158015610e14573d6000803e3d6000fd5b505060cd546040516331b6a3af60e21b8152600481018590526001600160a01b03909116925063c6da8ebc9150602401600060405180830381600087803b158015610e5e57600080fd5b505af1158015610e72573d6000803e3d6000fd5b5050505083604051610e849190611d20565b604051908190038120907fbc015a904ff24504645969b94495d3dca97f7f09cc97f0111757fabbb8459be190600090a285610ebe816119ad565b9650505050505050610ba6565b5050505050565b60009182526065602090815260408084206001600160a01b0393909316845291905290205460ff1690565b600080516020611f74833981519152610f1581611208565b60cc610f22838583611d8a565b50505050565b600054610100900460ff1615808015610f485750600054600160ff909116105b80610f625750303b158015610f62575060005460ff166001145b610fc55760405162461bcd60e51b815260206004820152602e60248201527f496e697469616c697a61626c653a20636f6e747261637420697320616c72656160448201526d191e481a5b9a5d1a585b1a5e995960921b6064820152608401610506565b6000805460ff191660011790558015610fe8576000805461ff0019166101001790555b846001600160a01b03811661100f5760405162461bcd60e51b815260040161050690611873565b846001600160a01b0381166110365760405162461bcd60e51b815260040161050690611873565b846001600160a01b03811661105d5760405162461bcd60e51b815260040161050690611873565b846001600160a01b0381166110845760405162461bcd60e51b815260040161050690611873565b61108c611302565b611094611333565b60cc6110a18b8d83611d8a565b5060cb80546001600160a01b03808c166001600160a01b03199283161790925560cd80548b841690831617905560ce8054928a16929091169190911790556110f7600080516020611f7483398151915287611215565b611102600033611215565b50505050801561114c576000805461ff0019169055604051600181527f7f26b83ff96e1f2b6a682f133852f6798a09c465da95921460cefb38474024989060200160405180910390a15b50505050505050565b60008281526065602052604090206001015461117081611208565b6105a3838361129b565b60cc805461118790611c30565b80601f01602080910402602001604051908101604052809291908181526020018280546111b390611c30565b80156112005780601f106111d557610100808354040283529160200191611200565b820191906000526020600020905b8154815290600101906020018083116111e357829003601f168201915b505050505081565b611212813361135a565b50565b61121f8282610ed2565b6106225760008281526065602090815260408083206001600160a01b03851684529091529020805460ff191660011790556112573390565b6001600160a01b0316816001600160a01b0316837f2f8788117e7eff1d82e926ec794901d17c78024a50270940304540a733656f0d60405160405180910390a45050565b6112a58282610ed2565b156106225760008281526065602090815260408083206001600160a01b0385168085529252808320805460ff1916905551339285917ff6391f5c32d9c69d2a47ea670b442974b53935d1edc7fd64eb21e047a839171b9190a45050565b600054610100900460ff166113295760405162461bcd60e51b815260040161050690611e4a565b6113316113b3565b565b600054610100900460ff166113315760405162461bcd60e51b815260040161050690611e4a565b6113648282610ed2565b61062257611371816113e6565b61137c8360206113f8565b60405160200161138d929190611e95565b60408051601f198184030181529082905262461bcd60e51b825261050691600401611860565b600054610100900460ff166113da5760405162461bcd60e51b815260040161050690611e4a565b6097805460ff19169055565b60606104d96001600160a01b03831660145b60606000611407836002611f0a565b611412906002611f29565b67ffffffffffffffff81111561142a5761142a6119fb565b6040519080825280601f01601f191660200182016040528015611454576020820181803683370190505b509050600360fc1b8160008151811061146f5761146f611af0565b60200101906001600160f81b031916908160001a905350600f60fb1b8160018151811061149e5761149e611af0565b60200101906001600160f81b031916908160001a90535060006114c2846002611f0a565b6114cd906001611f29565b90505b6001811115611545576f181899199a1a9b1b9c1cb0b131b232b360811b85600f166010811061150157611501611af0565b1a60f81b82828151811061151757611517611af0565b60200101906001600160f81b031916908160001a90535060049490941c9361153e81611f3c565b90506114d0565b5083156115945760405162461bcd60e51b815260206004820181905260248201527f537472696e67733a20686578206c656e67746820696e73756666696369656e746044820152606401610506565b9392505050565b6000602082840312156115ad57600080fd5b81356001600160e01b03198116811461159457600080fd5b80356001600160a01b03811681146115dc57600080fd5b919050565b6000602082840312156115f357600080fd5b611594826115c5565b60006020828403121561160e57600080fd5b5035919050565b6000806040838503121561162857600080fd5b82359150611638602084016115c5565b90509250929050565b60008083601f84011261165357600080fd5b50813567ffffffffffffffff81111561166b57600080fd5b60208301915083602082850101111561168357600080fd5b9250929050565b600080600080600080600080600060c08a8c0312156116a857600080fd5b893567ffffffffffffffff808211156116c057600080fd5b6116cc8d838e01611641565b909b50995060208c01359150808211156116e557600080fd5b6116f18d838e01611641565b909950975060408c0135965087915061170c60608d016115c5565b955060808c013591508082111561172257600080fd5b5061172f8c828d01611641565b9a9d999c50979a9699959894979660a00135949350505050565b6000806020838503121561175c57600080fd5b823567ffffffffffffffff81111561177357600080fd5b61177f85828601611641565b90969095509350505050565b60008060008060008060a087890312156117a457600080fd5b863567ffffffffffffffff8111156117bb57600080fd5b6117c789828a01611641565b90975095506117da9050602088016115c5565b93506117e8604088016115c5565b92506117f6606088016115c5565b9150611804608088016115c5565b90509295509295509295565b60005b8381101561182b578181015183820152602001611813565b50506000910152565b6000815180845261184c816020860160208601611810565b601f01601f19169290920160200192915050565b6020815260006115946020830184611834565b602080825260169082015275416464726573732063616e6e6f74206265207a65726f60501b604082015260600190565b81835281816020850137506000828201602090810191909152601f909101601f19169091010190565b6020815260006118e06020830184866118a3565b949350505050565b6000602082840312156118fa57600080fd5b5051919050565b60018060a01b038816815286602082015260c06040820152600061192960c0830187896118a3565b606083019590955250608081019290925260a090910152949350505050565b60c08152600061195c60c083018a8c6118a3565b828103602084015261196f81898b6118a3565b9150508560408301528460608301528360808301528260a08301529998505050505050505050565b634e487b7160e01b600052601160045260246000fd5b6000600182016119bf576119bf611997565b5060010190565b6000826119e357634e487b7160e01b600052601260045260246000fd5b500490565b818103818111156104d9576104d9611997565b634e487b7160e01b600052604160045260246000fd5b604051601f8201601f1916810167ffffffffffffffff81118282101715611a3a57611a3a6119fb565b604052919050565b60008060408385031215611a5557600080fd5b825167ffffffffffffffff80821115611a6d57600080fd5b818501915085601f830112611a8157600080fd5b8151602082821115611a9557611a956119fb565b8160051b9250611aa6818401611a11565b8281529284018101928181019089851115611ac057600080fd5b948201945b84861015611ade57855182529482019490820190611ac5565b97909101519698969750505050505050565b634e487b7160e01b600052603260045260246000fd5b805180151581146115dc57600080fd5b600082601f830112611b2757600080fd5b815167ffffffffffffffff811115611b4157611b416119fb565b611b54601f8201601f1916602001611a11565b818152846020838601011115611b6957600080fd5b6118e0826020830160208701611810565b60008060008060008060008060006101208a8c031215611b9957600080fd5b611ba28a611b06565b9850611bb060208b01611b06565b975060408a015167ffffffffffffffff80821115611bcd57600080fd5b611bd98d838e01611b16565b985060608c0151915080821115611bef57600080fd5b50611bfc8c828d01611b16565b96505060808a0151945060a08a0151935060c08a0151925060e08a015191506101008a015190509295985092959850929598565b600181811c90821680611c4457607f821691505b602082108103611c6457634e487b7160e01b600052602260045260246000fd5b50919050565b608081526000611c7d6080830187611834565b60208382038185015260008754611c9381611c30565b80855260018281168015611cae5760018114611cc857611cf6565b60ff1984168787015282151560051b870186019450611cf6565b8b6000528560002060005b84811015611cee578154898201890152908301908701611cd3565b880187019550505b505050508481036040860152611d0c8188611834565b935050505082606083015295945050505050565b60008251611d32818460208701611810565b9190910192915050565b601f8211156105a357600081815260208120601f850160051c81016020861015611d635750805b601f850160051c820191505b81811015611d8257828155600101611d6f565b505050505050565b67ffffffffffffffff831115611da257611da26119fb565b611db683611db08354611c30565b83611d3c565b6000601f841160018114611dea5760008515611dd25750838201355b600019600387901b1c1916600186901b178355610ecb565b600083815260209020601f19861690835b82811015611e1b5786850135825560209485019460019092019101611dfb565b5086821015611e385760001960f88860031b161c19848701351681555b505060018560011b0183555050505050565b6020808252602b908201527f496e697469616c697a61626c653a20636f6e7472616374206973206e6f74206960408201526a6e697469616c697a696e6760a81b606082015260800190565b7f416363657373436f6e74726f6c3a206163636f756e7420000000000000000000815260008351611ecd816017850160208801611810565b7001034b99036b4b9b9b4b733903937b6329607d1b6017918401918201528351611efe816028840160208801611810565b01602801949350505050565b6000816000190483118215151615611f2457611f24611997565b500290565b808201808211156104d9576104d9611997565b600081611f4b57611f4b611997565b50600019019056fe40bf7f3e050c58df3c22a30156b81755aff2fd367a210e5b2226b5a8c66b9bff498b825d537fdac7885a1e14e556b5eb758e102ac6f81d44f1f629c8f25a7cefa2646970667358221220eaf27804d7085c6ad8fa98c8a95b095073f1b40fa3a8f81475d24662ae18421064736f6c63430008100033")
	// Get dependencies
	//rocketMinipoolFactory, err := getRocketMinipoolFactory(rp, opts)
	//if err != nil {
	//	return common.Address{}, err
	//}
	//minipoolAbi, err := rp.GetABI("rocketMinipool", opts)
	//if err != nil {
	//	return common.Address{}, err
	//}
	//
	//if len(minipoolBytecode) == 0 {
	//	minipoolBytecode, err = minipool.GetMinipoolBytecode(rp, nil)
	//	if err != nil {
	//		return common.Address{}, fmt.Errorf("Error getting minipool bytecode: %w", err)
	//	}
	//}
	//
	//// Create the hash of the minipool constructor call
	//depositTypeBytes := [32]byte{}
	//depositTypeBytes[0] = byte(depositType)
	//packedConstructorArgs, err := minipoolAbi.Pack("", rp.RocketStorageContract.Address, nodeAddress, depositType)
	//if err != nil {
	////	return common.Address{}, fmt.Errorf("Error creating minipool constructor args: %w", err)
	////}

	// Get the node salt and initialization data
	nodeSalt := GetNodeSalt(nodeAddress, salt)
	//initData := append(minipoolBytecode)
	initHash := crypto.Keccak256(minipoolBytecodeCurrent)

	//addressType := []byte("0x512d03379c135b464B0C62847141eEEd6ccb1bd8")

	address := crypto.CreateAddress2(nodeAddress, nodeSalt, initHash)
	return address, nil

}

// Get contracts
//var rocketMinipoolFactoryLock sync.Mutex
//
//func getRocketMinipoolFactory(rp *stader.EthxContractManager, opts *bind.CallOpts) (*stader.Contract, error) {
//	rocketMinipoolFactoryLock.Lock()
//	defer rocketMinipoolFactoryLock.Unlock()
//	return rp.GetContract("rocketMinipoolFactory", opts)
//}
